---
title: "Untitled"
author: "Jason Torres"
date: "December 11, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup 


```{r}
"%&%" <- function(a,b) paste0(a,b)

library("data.table")
library("tidyverse")
#library("Homo.sapiens")
#library(gridExtra)
#library(grid)

server.dir <- "/Users/jtorres/FUSE/"

work.dir <- server.dir %&% "projects/mv-compare/"
input.dir <- work.dir %&% "input_files/"
output.dir <- work.dir %&% "output_files/"

known.genefile <- input.dir %&% "causal_genes3.txt"
metab.df <- fread(known.genefile)
plot.dir <- work.dir %&% "plots/"

mtxn.df <- fread(input.dir %&% "metaxcan_full_results_filtered_for_model_fit_and_pval_at_0.01.txt")

hmdb.df <- fread(work.dir %&% "hmdb/hmdb.txt")

```



```{r}

#mtxn.df$known <- map(mtxn.df$gene_name,function(g){g %in% metab.df$predicted_causal}) %>% 
#  as.logical(.)
mtxn.df$known <- map(1:dim(mtxn.df)[1],function(i){
  m <- mtxn.df$metabolite[i]
  g <- mtxn.df$gene_name[i]
  g %in% filter(metab.df,MetaboID==m)$predicted_causal}) %>% 
  as.logical(.)
mtxn.df$hmdb <- map(mtxn.df$gene_name,function(g){g %in% hmdb.df$gene_name}) %>% 
  as.logical(.)

sub <- select(mtxn.df,one_of("gene_name","known","hmdb")); sub <- sub[!duplicated(sub),]

dim(filter(sub,known==TRUE,hmdb==FALSE))[1] # 5 known genes not in HMDB 
dim(filter(sub,known==TRUE,hmdb==TRUE))[1] # 36 known genes in HMDB

novel.df <- filter(sub,known==FALSE,hmdb==TRUE)

# 27% of novel gene associations are in hmdb 
dim(filter(sub,known==FALSE,hmdb==TRUE))[1]/dim(filter(sub,known==FALSE))[1] # 0.2733711

```



```{r}


get_metab_annot <- function(query.gene){
  q.df <- filter(hmdb.df,gene_name==query.gene)
  if (dim(q.df)[1] > 0){
    go.vec <- strsplit(q.df$go_classifications,split="GO:\\d+",fixed=FALSE)[[1]]
    go.ids <- regmatches(q.df$go_classifications, gregexpr("GO:\\d+", q.df$go_classifications))[[1]]
    path.vec <- strsplit(q.df$pathways,split="map\\d{5}",fixed=FALSE)[[1]] %>% 
      map(.,function(s){strsplit(s,split="SMP\\d{5}",fixed=FALSE)[[1]]}) %>% unlist(.)
    return(list(go.ids,path.vec))    
  } 
  else{
    return(list(NA,NA))
  }
}

#get_metab_annot("NT5C1B")

group_metab_assoc_genes <- function(metab){
  gene.vec <- filter(mtxn.df,metabolite==metab)$gene_name %>% unique(.)
  known.vec <- gene.vec[gene.vec %in% filter(metab.df,MetaboID==metab)$predicted_causal]
  novel.vec <- gene.vec[!(gene.vec %in% filter(metab.df,MetaboID==metab)$predicted_causal)]
  return(list(known.vec,novel.vec))
}

compare_gene_annotations <- function(gene1,gene2,annot.num){
  # annot.num = 1; use GO IDs 
  # annot.num = 2; use hmdb pathway names 
  g1 <- get_metab_annot(gene1)[[annot.num]]
  g2 <- get_metab_annot(gene2)[[annot.num]]
  overlap <- intersect(g1,g2)
  if (length(overlap)==0){
    return("None")
  } else{
    return(overlap)
  }
}

build_single_metab_df <- function(metab,alt=FALSE){
  l <- group_metab_assoc_genes(metab)  
  known.vec <- l[[1]]
  novel.vec <- l[[2]]

  out.df <- c()
  k.df <- data.frame(Gene=known.vec,
                     Group=rep("known",length(known.vec)),
                     go.shared.known=rep("-",length(known.vec)),
                     path.shared.known=rep("-",length(known.vec)),
                     stringsAsFactors = FALSE)
  out.df <- rbind(out.df,k.df)
  
  if (alt==TRUE){
    known.vec <- filter(metab.df,MetaboID==metab)$predicted_causal %>% unique(.)
  }
  known.goids <- map(known.vec,function(k){get_metab_annot(k)[[1]]}) %>% unlist(.) %>% unique(.) %>% na.omit(.)
  known.paths <- map(known.vec,function(k){get_metab_annot(k)[[2]]}) %>% unlist(.) %>% unique(.) %>% na.omit(.)  
  
  for (n in novel.vec){
    #print(n)
    go.ids <- get_metab_annot(n)[[1]]
    path.ids <- get_metab_annot(n)[[2]]
    
    path.eval <- any(path.ids %in% known.paths)==TRUE
    if (path.eval==FALSE & length(path.ids) > 0 & is.na(path.ids) ==FALSE){
      eval.vec <- c(unlist(map(path.ids,function(id){grepl(id,known.paths,fixed=TRUE)})),
                    unlist(map(known.paths,function(id){grepl(id,path.ids,fixed=TRUE)})))
      if (any(eval.vec)==TRUE){
        path.eval=TRUE
      }else{
        path.eval=FALSE
      }
    }
    
    build.df <- data.frame(Gene=n,
                     Group="novel",
                     go.shared.known=any(go.ids %in% known.goids)==TRUE,
                     path.shared.known=path.eval,
                     stringsAsFactors = FALSE)
    out.df <- rbind(out.df,build.df)
  }
  out.df <- data.frame(Metabolite=rep(metab,dim(out.df)[1]),out.df)
  return(out.df)
}

build_full_metab_df <- function(alt=FALSE){
  metab.vec <- unique(mtxn.df$metabolite)
  out.df <- c()
  pb <- txtProgressBar(min=0,max=length(metab.vec),style=3)
  for (i in 1:length(metab.vec)){
    setTxtProgressBar(pb,i)
    metab <- metab.vec[i]
    #print(metab)
    build.df <- build_single_metab_df(metab,alt)
    out.df <- rbind(out.df,build.df)
  }
  out.df$Metabolite <- as.character(out.df$Metabolite)
  return(out.df)
}

full.df <- build_full_metab_df(alt=TRUE)


```



# Summary 

```{r}

# 26% of novel gene associations are in hmdb 
dim(filter(sub,known==FALSE,hmdb==TRUE))[1]/dim(filter(sub,known==FALSE))[1] # 0.2647482

m.vec <- full.df$Metabolite %>% unique(.)
log.vec <- map(m.vec,function(m){dim(filter(full.df,Metabolite==m,Group=="known"))[1]>0}) %>% as.logical(.)
keep.metabs <- m.vec[log.vec]

nov.df <- filter(full.df,Group=="novel",Metabolite %in% keep.metabs)
path.count = 0 
go.count = 0 
for (g in unique(nov.df$Gene)){
  g.df <- filter(nov.df,Gene==g)
  path.count <- path.count + as.integer(any(g.df$path.shared.known == TRUE))
  go.count <- go.count + as.integer(any(g.df$go.shared.known == TRUE))
}

path.count / length(unique(nov.df$Gene)) # 5% of novel genes are in the same hmdb pathways as the known genes associated with metab
go.count / length(unique(nov.df$Gene)) # % 4% of novel genes are in the same go pathways as the known genes associated with metab

```

